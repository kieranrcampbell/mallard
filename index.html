<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Mallard : Data Acquisition for the CRIS experiment at ISOLDE" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Mallard</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/kieranrcampbell/mallard">View on GitHub</a>

          <h1 id="project_title">Mallard</h1>
          <h2 id="project_tagline">Data Acquisition for the CRIS experiment at ISOLDE</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/kieranrcampbell/mallard/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/kieranrcampbell/mallard/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>
<a name="mallard-for-cris-at-isolde" class="anchor" href="#mallard-for-cris-at-isolde"><span class="octicon octicon-link"></span></a>Mallard for CRIS at <a href="http://isolde.web.cern.ch/">ISOLDE</a>
</h3>

<p>Mallard (Multi-Analog LossLess Acquisition of Resonance Data) is data acquisition software for the Collinear Resonant Ionization Spectroscopy experiment at CERN.</p>

<h3>
<a name="contents" class="anchor" href="#contents"><span class="octicon octicon-link"></span></a>Contents</h3>

<ul>
<li><a href="#resources">Online Resources</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#use">Use</a></li>
<li><a href="#development">Development</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#authors">Authors</a></li>
</ul><h3>
<a name="resources" class="anchor" href="#resources"><span class="octicon octicon-link"></span></a>Resources</h3>

<p>Github Repository: <a href="https://github.com/kieranrcampbell/mallard">https://github.com/kieranrcampbell/mallard</a></p>

<p>Documentation: <a href="http://kieranrcampbell.github.io/mallard/">http://kieranrcampbell.github.io/mallard/</a></p>

<p>Sourceforge page: <a href="https://sourceforge.net/projects/mallardforcris/">https://sourceforge.net/projects/mallardforcris/</a></p>

<h3>
<a name="introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h3>

<h4>
<a name="etymology" class="anchor" href="#etymology"><span class="octicon octicon-link"></span></a>Etymology</h4>

<p>Two things frequently occur at CERN: everything is an acronym (CERN, LHC, ATLAS, ALICE,
ISOLDE, CRIS, ...), and the DAQ/duck joke is made (a yellow rubber duck sits on the data acquisition
desk in the ATLAS control room). The obvious challenge then for any self respecting summer student is
to combine both of these, and so came Mallard: Multi Analog LossLess Acquistion of Resonance Data</p>

<h4>
<a name="purpose" class="anchor" href="#purpose"><span class="octicon octicon-link"></span></a>Purpose</h4>

<p>Mallard is designed for efficient data acquisition and experimental control on the CRIS experiment at ISOLDE at CERN. The software interfaces a National Instruments USB-6211 card that connects to the lasers, counters and trigger. The experiment requires the software  to scan across a range of voltages set on an analogue output, and at each voltage measure counts (from the MCP) and an analogue input (relative intensity of the laser). The user selects the voltage range across which to scan, how many volts should be set in a given interval, and how many scans across the full voltage range should be performed. The timing of the voltage change comes from an external trigger that is also connected to the scanning laser.</p>

<p>During the data acquisition the software continuously graphs the current count rate and analogue input voltage measured, as well as the average so far in order to provide the user with an idea of whether the measurements are drifting from normal. The raw data of counts and analogue input measurements is collected and saved to disk, as well as an integrated file showing the measurements at each voltage averaged over a number of scans.</p>

<h3>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h3>

<p>Mallard is written in python and so requires a python distribution such as <a href="https://store.continuum.io/">Anaconda</a>.</p>

<h4>
<a name="dependencies" class="anchor" href="#dependencies"><span class="octicon octicon-link"></span></a>Dependencies</h4>

<p>Mallard has the following dependencies:</p>

<ul>
<li><a href="http://www.wxpython.org/">wxPython</a></li>
<li>
<a href="http://www.scipy.org/">SciPy</a> (on windows we use <a href="https://store.continuum.io/">Anaconda</a> )</li>
<li><a href="http://pythonhosted.org/PyDAQmx/">PyDAQmx</a></li>
</ul><p>Installing SciPy on Windows can be tedious, so use <a href="https://store.continuum.io/">Anaconda</a> which comes with it pre-installed. Don't install wxPython using <code>easy_install</code> or <code>pip</code> as these install some bizarre empty package. Instead, download the windows installer directly from their website (see above).</p>

<h4>
<a name="nidaqmx" class="anchor" href="#nidaqmx"><span class="octicon octicon-link"></span></a>NIDAQmx</h4>

<p><a href="http://www.ni.com/dataacquisition/nidaqmx">NIDAQmx</a> from National Instruments provides the base set of drivers to interface the card. The full set of functionality is only available on Windows. At time of writing the latest version was 9.7 which can be downloaded from <a href="http://joule.ni.com/nidu/cds/view/p/id/3811/lang/en">http://joule.ni.com/nidu/cds/view/p/id/3811/lang/en</a>. NIDAQmx installs a header file containing all the C library function definitions. The location of this file must be noted and an installation file in PyDAQmx modified accordingly (see PyDAQmx documentation for details).</p>

<h4>
<a name="mallard" class="anchor" href="#mallard"><span class="octicon octicon-link"></span></a>Mallard</h4>

<h5>
<a name="from-source" class="anchor" href="#from-source"><span class="octicon octicon-link"></span></a>From source</h5>

<p>The source code can be downloaded (as zip or tar.gz) from the <a href="https://github.com/kieranrcampbell/mallard">github repository</a>. Extract it to a convenient folder then, from the top level <code>mallard</code> directory it can be installed by <code>python setup.py install</code>. Then mallard can be launched in the usual way, or if you prefer to use it within a python script itself it can be called using <code>import mallard</code> etc.</p>

<h5>
<a name="windows-installer" class="anchor" href="#windows-installer"><span class="octicon octicon-link"></span></a>Windows installer</h5>

<p>A windows installer for the python package can be downloaded from the <a href="https://sourceforge.net/projects/mallardforcris/">sourceforge page</a> which will install it as a python package.</p>

<h5>
<a name="system-requirements" class="anchor" href="#system-requirements"><span class="octicon octicon-link"></span></a>System requirements</h5>

<p>Due to the availability of NI-DAQmx Mallard only runs on windows. Despite all data being held in RAM, during system tests it was found that 500 scans with 50 intervals per scan only takes up about 150MB, so this is certainly not a limiting factor.</p>

<h3>
<a name="use" class="anchor" href="#use"><span class="octicon octicon-link"></span></a>Use</h3>

<h4>
<a name="basic-capture" class="anchor" href="#basic-capture"><span class="octicon octicon-link"></span></a>Basic Capture</h4>

<p>To begin Mallard, navigate to the root mallard folder, and start by</p>

<pre><code>python -m mallard.main
</code></pre>

<p>Due to a multiprocessing bug under python on windows we can't have the usual <strong>main</strong>.py folder to begin the module as <code>python mallard</code>.</p>

<p>Each acquisition session of data corresponding to a particular set of settings is known as a capture. Each capture is represented by a tab in the GUI, and a new capture can be opened by File -&gt; New Capture. Captures can be saved (see below), but cannot be reloaded into Mallard as there is currently no data analysis functionality. However, the settings for a new capture can be loaded from an old capture by File -&gt; Load Capture then selecting the capture you wish to open.</p>

<p>The capture begins by pressing 'Start Capture', and can be stopped by selecting Capture -&gt; Kill Capture. The current voltage and MCP count is displayed on the screen, as well as the scan average superimposed on the graph. The graph can be saved at any time using the Matplotlib functionality on screen. </p>

<p>The graph style can be changed at any time by going to File -&gt; Preferences. The graph style can be set separately for the count graph and for the voltage graph. There are three different types:</p>

<ul>
<li>Step (histogram): Essentially bins the data exactly like a histogram</li>
<li>Line: joins consecutive data points using lines</li>
<li>Points: Each data point is represented by a separate point. For the count graph this has error bars, which are given by root(N) for N counts.</li>
</ul><p>In these preferences you can also set the style of the 'mean'. Selecting 'normalised' graphs each count divided by the number of scans, whereas 'cumulative' gives the sum of all counts across all scans. </p>

<p>Plots can be saved using the controls on the plot itself. To move the plot around, select the 'Pan' symbol and drag with the left mouse click. To zoom in and out, both horizontally and vertically, select the 'Pan' symbol and drag with the right mouse button.</p>

<h5>
<a name="key-concepts" class="anchor" href="#key-concepts"><span class="octicon octicon-link"></span></a>Key Concepts</h5>

<ul>
<li>
<strong>Voltage minimum</strong>: The voltage from which the laser starts scanning</li>
<li>
<strong>Voltage maximum</strong>: The voltage to which the laser will scan</li>
<li>
<strong>Intervals per scan</strong>: The number of intervals to scan in the voltage range</li>
<li>
<strong>Scans</strong>: The number of full scans to do (from minimum to maximum across the range)</li>
<li>
<strong>Clock cycles per interval</strong>: The number of onboard clock cycles to wait per scan (known as the 'rate' in NI terminology, 100 is a good number)</li>
<li>
<strong>Analog input</strong>: Analog input channel (default /Dev1/ai2)</li>
<li>
<strong>Counter input</strong>: Input channel for counting events. This is a 'virtual' channel, which requires looking at the NI handbook, but Dev1/ctr1 corresponds to Dev1/PFI1 on the 6211</li>
<li>
<strong>Analog output</strong>: Analog output channel (default /Dev1/ao0)</li>
<li>
<strong>Clock input</strong>: Input channel for the pseudo-trigger clock</li>
</ul><h5>
<a name="file-output" class="anchor" href="#file-output"><span class="octicon octicon-link"></span></a>File Output</h5>

<p>When mallard runs it creates two datasets: every count measurement at every interval across every scan, and likewise for the analog input readings. These are then averaged over the scans to give a third 'integrated' dataset. As such, mallard outputs 3 data files. If the capture name is 'mycapture' then these files are:</p>

<ul>
<li>
<strong>mycapture.integrated.csv</strong>: contains the integrated (final) dataset across all scans</li>
<li>
<strong>mycapture.raw.counts.csv</strong>: contains the raw count data for all intervals and scans</li>
<li>
<strong>mycapture.raw.ai.csv</strong>: contains the raw analog input information for all intervals and scans</li>
</ul><p>Each of these files is in comma separated value format and contains a header, denoted by '#' at the beginning of each line, containing the settings listed in key concepts above. As such, any file can be used to recover capture settings for a new capture.</p>

<p>Mallard doesn't yet have any in built analysis, but with the data in this format it should be easy enough. The data can be opened directly in excel, or using numpy in python as follows:</p>

<div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">'mycapture.integrated.csv'</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">','</span><span class="p">)</span>
<span class="n">voltage_intervals</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># need to transpose matrix</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ai_readings</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>

<p>and <code>voltage</code>, <code>counts</code> and <code>ai_readings</code> can be analysed using any of the standard tools in SciPy.</p>

<h3>
<a name="development" class="anchor" href="#development"><span class="octicon octicon-link"></span></a>Development</h3>

<p>Mallard is written in python and is under git source control.</p>

<h4>
<a name="package-layout" class="anchor" href="#package-layout"><span class="octicon octicon-link"></span></a>Package Layout</h4>

<p>The mallard package is organised into several sub-packages:</p>

<h5>
<a name="mallardcore" class="anchor" href="#mallardcore"><span class="octicon octicon-link"></span></a>mallard.core</h5>

<p>This provides base functionality for the package including data and file handling. <code>CaptureSession</code> represents an abstract (ie has no attached daq interface or gui), and manages calls for file management and data acquisition. <code>SessionSettings</code> represents the settings for a given capture session, including input, output and counter channels. <code>CaptureSession</code> holds the 'master' copy, though since everything in python is a pointer all copies (held by all <code>mallard.core</code> modules). However, after settings are changed some things must be recalculated (such as voltage intervals), so if a module uses <code>SessionSettings</code> it's not okay to assume changes elsewhere will be safely reflected in the current location. <code>DataManager</code> holds runtime data and has the <code>queue.get()</code> method to receive data from the interface. It also calculates the averages across scans, and calls the <code>GraphManager</code> (which provides the interface between <code>mallard.core</code> and the gui package). <code>FileManager</code> deals with file input and output. It can generate the header from <code>SessionSettings</code> and can read in and parse settings and filenames.</p>

<h5>
<a name="mallarddaq" class="anchor" href="#mallarddaq"><span class="octicon octicon-link"></span></a>mallard.daq</h5>

<p>This contains only one module called <code>Acquire</code> that interfaces the USB-6211 card. If the card needs changed in future then only this module needs rewritten. It is the only module in the entire package that is just a function, as spawning processes that are class methods using the <code>multiprocessing</code> module is very difficult (maybe impossible?). All this module needs are the session settings (for channel names and rates) and a <code>multiprocessing.Queue</code> to report the data back to <code>DataManager</code>.</p>

<h5>
<a name="mallardgui" class="anchor" href="#mallardgui"><span class="octicon octicon-link"></span></a>mallard.gui</h5>

<p>This provides the graphical user interface using wxPython. <code>MFrame</code> is the base <code>wx.Frame</code> used, which owns a <code>CaptureNotebook</code>. This <code>CaptureNotebook</code> holds <code>CapturePane</code>s, each of which corresponds to a <code>CaptureSession</code>. The <code>GraphManager</code> provides a link between the <code>DataManager</code> and the gui, updating the graph on screen with the data coming in. <code>SettingsDialog</code> simply displays a dialog that lets the user change all the different settings.</p>

<h5>
<a name="mallardtest" class="anchor" href="#mallardtest"><span class="octicon octicon-link"></span></a>mallard.test</h5>

<p>Holds all the obsolete and test scripts created along the way, in case they come in handy at a later point. May be changed to `old' in future. </p>

<h3>
<a name="troubleshooting" class="anchor" href="#troubleshooting"><span class="octicon octicon-link"></span></a>Troubleshooting</h3>

<h4>
<a name="mallard-errors" class="anchor" href="#mallard-errors"><span class="octicon octicon-link"></span></a>Mallard errors</h4>

<h6>
<a name="importerror-matplotlib-backend_wx-and-backend_wxagg-require-wxversion-which-was-not-found" class="anchor" href="#importerror-matplotlib-backend_wx-and-backend_wxagg-require-wxversion-which-was-not-found"><span class="octicon octicon-link"></span></a>ImportError: Matplotlib backend_wx and backend_wxagg require wxversion, which was not found.</h6>

<p>Sometimes the wxversion module is missing. Download it from <a href="http://svn.wxwidgets.org/viewvc/wx/wxPython/trunk/wxversion/wxversion.py?view=co">http://svn.wxwidgets.org/viewvc/wx/wxPython/trunk/wxversion/wxversion.py?view=co</a> and install in your <code>site-packages</code> directory (for Anaconda this is usually <code>C:/Anaconda/lib/site-packages</code>).</p>

<h4>
<a name="nidaqmx-errors" class="anchor" href="#nidaqmx-errors"><span class="octicon octicon-link"></span></a>NIDAQmx Errors</h4>

<h5>
<a name="the-specified-resource-is-reserved-the-operation-could-not-be-completed-as-specified" class="anchor" href="#the-specified-resource-is-reserved-the-operation-could-not-be-completed-as-specified"><span class="octicon octicon-link"></span></a>The specified resource is reserved. The operation could not be completed as specified.</h5>

<p>This means a task is still running on the device. To end the task and recover, open the NIDAQmx utility from Start -&gt; National Instruments -&gt; NiMAX. Select Devices and Interfaces -&gt; NI USB 6211 then select 'Reset Device', and await confirmation.</p>

<h3>
<a name="authors" class="anchor" href="#authors"><span class="octicon octicon-link"></span></a>Authors</h3>

<p>Originally written by Kieran Campbell (<a href="https://github.com/kieranrcampbell" class="user-mention">@kieranrcampbell</a>) as part of the CERN summer student program.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Mallard maintained by <a href="https://github.com/kieranrcampbell">kieranrcampbell</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
